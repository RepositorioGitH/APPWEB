<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inventario de Materiales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 font-sans p-4">

    <div class="max-w-6xl mx-auto bg-white p-6 rounded-2xl shadow-lg">
        <h1 class="text-2xl font-bold text-center text-indigo-700 mb-6">üì¶ Sistema de Inventario de Materiales</h1>

        <div class="flex flex-wrap justify-center gap-3 mb-6">
            <button id="addBtn" onclick="addProduct()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold">‚ûï Agregar</button>
            <button id="downloadBtn" onclick="downloadExcel()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold">‚¨áÔ∏è Inventario Excel</button>
            <button id="downloadHistoryBtn" onclick="downloadHistoryExcel()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-semibold">üìò Historial Excel</button>
        </div>

        <table id="productTable" class="w-full border-collapse border border-gray-300">
            <thead class="bg-gray-200">
                <tr>
                    <th class="border border-gray-300 px-2 py-1">#</th>
                    <th class="border border-gray-300 px-2 py-1">Producto</th>
                    <th class="border border-gray-300 px-2 py-1">Cantidad</th>
                    <th class="border border-gray-300 px-2 py-1">Acciones</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script>
        let products = [];
        let movements = [];

        function addProduct() {
            const name = prompt("Nombre del producto:");
            const qty = parseInt(prompt("Cantidad inicial:"), 10);
            if (name && !isNaN(qty)) {
                products.push({ name, quantity: qty });
                movements.push({ 
                    date: Date.now(), 
                    productName: name, 
                    type: "entrada", 
                    quantity: qty, 
                    description: "Producto agregado manualmente",
                    createdBy: "Administrador"
                });
                renderTable();
            }
        }

        function renderTable() {
            const tbody = document.getElementById("tableBody");
            tbody.innerHTML = "";
            products.forEach((p, i) => {
                const tr = document.createElement("tr");
                tr.innerHTML = \`
                    <td class="border px-2 py-1">\${i + 1}</td>
                    <td class="border px-2 py-1">\${p.name}</td>
                    <td class="border px-2 py-1">\${p.quantity}</td>
                    <td class="border px-2 py-1">
                        <button onclick="removeProduct(\${i})" class="bg-red-600 text-white px-2 py-1 rounded">Eliminar</button>
                    </td>
                \`;
                tbody.appendChild(tr);
            });
        }

        function removeProduct(index) {
            const removed = products.splice(index, 1)[0];
            movements.push({
                date: Date.now(),
                productName: removed.name,
                type: "salida",
                quantity: removed.quantity,
                description: "Producto eliminado",
                createdBy: "Administrador"
            });
            renderTable();
        }

        // ‚úÖ Exportar inventario actual
        function downloadExcel() {
            try {
                if (!products || products.length === 0) {
                    alert("‚ö†Ô∏è No hay productos para exportar a Excel");
                    return;
                }
                window.open("intent://download#Intent;scheme=data;end");
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(products);
                XLSX.utils.book_append_sheet(wb, ws, "Inventario");
                const wbout = XLSX.write(wb, { bookType: "xlsx", type: "base64" });
                const link = document.createElement("a");
                link.href = "data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64," + wbout;
                link.download = "Inventario.xlsx";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                alert("‚úÖ Archivo Excel generado correctamente");
            } catch (error) {
                console.error("‚ùå Error generando Excel:", error);
                alert("‚ö†Ô∏è Error al generar el archivo Excel");
            }
        }

        // ‚úÖ Exportar historial completo a Excel (compatible con Kodular)
        function downloadHistoryExcel() {
            try {
                if (!movements || movements.length === 0) {
                    alert("‚ö†Ô∏è No hay movimientos en el historial para exportar");
                    return;
                }
                window.open("intent://download#Intent;scheme=data;end");
                const wb = XLSX.utils.book_new();
                const historyData = movements.map((m, index) => ({
                    "#": index + 1,
                    Fecha: new Date(m.date).toLocaleString("es-ES"),
                    Producto: m.productName || "Desconocido",
                    Tipo: m.type === "entrada" ? "Entrada" : "Salida",
                    Cantidad: m.quantity,
                    Descripci√≥n: m.description || "",
                    Usuario: m.createdBy || "Desconocido"
                }));
                const ws = XLSX.utils.json_to_sheet(historyData);
                XLSX.utils.book_append_sheet(wb, ws, "Historial");
                const wbout = XLSX.write(wb, { bookType: "xlsx", type: "base64" });
                const link = document.createElement("a");
                link.href = "data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64," + wbout;
                link.download = "Historial_Movimientos.xlsx";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                alert("‚úÖ Historial descargado correctamente en formato Excel");
            } catch (error) {
                console.error("‚ùå Error exportando historial:", error);
                alert("‚ö†Ô∏è Error al generar el archivo Excel");
            }
        }
    </script>
</body>
</html>
