<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inventario de Materiales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        .alert-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        .status-badge {
            font-weight: 600;
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl card-shadow max-w-md w-full mx-4 overflow-hidden">
            <div class="gradient-bg text-white px-8 py-6">
                <h3 class="text-2xl font-bold">üîê Iniciar Sesi√≥n</h3>
                <p class="text-blue-100 mt-1">Accede al sistema de inventario</p>
            </div>
            <div class="p-8">
                <form id="loginForm">
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Usuario</label>
                        <input type="text" id="username" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" placeholder="Ingresa tu usuario">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Contrase√±a</label>
                        <input type="password" id="password" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" placeholder="Ingresa tu contrase√±a">
                    </div>

                    <button type="submit" class="w-full btn-primary text-white py-3 px-6 rounded-xl font-semibold">
                        Iniciar Sesi√≥n
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header id="mainHeader" class="gradient-bg text-white shadow-lg hidden">
        <div class="container mx-auto px-4 sm:px-6 py-4 sm:py-6 lg:py-8">
            <!-- Mobile Layout -->
            <div class="block lg:hidden">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="bg-white bg-opacity-20 p-2 rounded-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-xl sm:text-2xl font-bold">Sistema de Inventario</h1>
                            <p class="text-blue-100 text-sm hidden sm:block">Control de materiales</p>
                        </div>
                    </div>
                    <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg font-semibold transition-all duration-300 flex items-center space-x-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H3"></path>
                        </svg>
                        <span class="hidden sm:inline">Salir</span>
                    </button>
                </div>
                <div class="bg-white bg-opacity-10 rounded-lg p-3">
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>
                            <p class="text-blue-100">Usuario: <span id="currentUserMobile" class="font-semibold"></span></p>
                            <p class="text-blue-100">Rol: <span id="currentRoleMobile" class="font-semibold"></span></p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-blue-100">Actualizado:</p>
                            <p class="text-xs text-blue-100 font-medium" id="lastUpdateMobile">--</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Desktop Layout -->
            <div class="hidden lg:flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="bg-white bg-opacity-20 p-3 rounded-xl">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold">Sistema de Inventario</h1>
                        <p class="text-blue-100 mt-1">Control profesional de materiales y stock</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <p class="text-sm text-blue-100">Usuario: <span id="currentUser" class="font-semibold"></span></p>
                        <p class="text-sm text-blue-100">Rol: <span id="currentRole" class="font-semibold"></span></p>
                        <p class="text-xs text-blue-100 mt-1">√öltima actualizaci√≥n: <span id="lastUpdate">--</span></p>
                    </div>
                    <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition-all duration-300 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H3"></path>
                        </svg>
                        <span>Cerrar Sesi√≥n</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div id="mainContent" class="container mx-auto px-4 sm:px-6 py-4 sm:py-6 lg:py-8 hidden">

        <!-- Low Stock Alerts -->
        <div id="alertsContainer" class="mb-4 sm:mb-6"></div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 lg:gap-6 mb-6 sm:mb-8">
            <div class="bg-white rounded-lg sm:rounded-xl p-4 sm:p-6 card-shadow">
                <div class="flex items-center">
                    <div class="p-2 sm:p-3 rounded-full bg-blue-100 text-blue-600">
                        <svg class="w-4 h-4 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                    </div>
                    <div class="ml-3 sm:ml-4">
                        <p class="text-xs sm:text-sm font-medium text-gray-600">Total Productos</p>
                        <p class="text-lg sm:text-2xl font-bold text-gray-900" id="totalProducts">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg sm:rounded-xl p-4 sm:p-6 card-shadow">
                <div class="flex items-center">
                    <div class="p-2 sm:p-3 rounded-full bg-red-100 text-red-600">
                        <svg class="w-4 h-4 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <div class="ml-3 sm:ml-4">
                        <p class="text-xs sm:text-sm font-medium text-gray-600">Stock Bajo</p>
                        <p class="text-lg sm:text-2xl font-bold text-gray-900" id="lowStockCount">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg sm:rounded-xl p-4 sm:p-6 card-shadow">
                <div class="flex items-center">
                    <div class="p-2 sm:p-3 rounded-full bg-green-100 text-green-600">
                        <svg class="w-4 h-4 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"></path>
                        </svg>
                    </div>
                    <div class="ml-3 sm:ml-4">
                        <p class="text-xs sm:text-sm font-medium text-gray-600">Entradas Hoy</p>
                        <p class="text-lg sm:text-2xl font-bold text-gray-900" id="todayEntries">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg sm:rounded-xl p-4 sm:p-6 card-shadow">
                <div class="flex items-center">
                    <div class="p-2 sm:p-3 rounded-full bg-orange-100 text-orange-600">
                        <svg class="w-4 h-4 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H3"></path>
                        </svg>
                    </div>
                    <div class="ml-3 sm:ml-4">
                        <p class="text-xs sm:text-sm font-medium text-gray-600">Salidas Hoy</p>
                        <p class="text-lg sm:text-2xl font-bold text-gray-900" id="todayExits">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="bg-white rounded-lg sm:rounded-xl p-4 sm:p-6 card-shadow mb-6 sm:mb-8">
            <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-4">Acciones R√°pidas</h3>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                <button onclick="showAddProductModal()" class="btn-primary text-white px-3 sm:px-6 py-2 sm:py-3 rounded-lg sm:rounded-xl font-semibold flex items-center justify-center space-x-1 sm:space-x-2 text-sm sm:text-base">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <span>Agregar</span>
                </button>
                <button onclick="showMovementModal('entrada')" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 sm:px-6 py-2 sm:py-3 rounded-lg sm:rounded-xl font-semibold transition-all duration-300 hover:transform hover:-translate-y-1 flex items-center justify-center space-x-1 sm:space-x-2 text-sm sm:text-base">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"></path>
                    </svg>
                    <span>Entrada</span>
                </button>
                <button onclick="showMovementModal('salida')" class="bg-orange-600 hover:bg-orange-700 text-white px-3 sm:px-6 py-2 sm:py-3 rounded-lg sm:rounded-xl font-semibold transition-all duration-300 hover:transform hover:-translate-y-1 flex items-center justify-center space-x-1 sm:space-x-2 text-sm sm:text-base">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H3"></path>
                    </svg>
                    <span>Salida</span>
                </button>
                <button id="historyBtn" onclick="showHistoryModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-3 sm:px-6 py-2 sm:py-3 rounded-lg sm:rounded-xl font-semibold transition-all duration-300 hover:transform hover:-translate-y-1 flex items-center justify-center space-x-1 sm:space-x-2 text-sm sm:text-base">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span class="hidden sm:inline">Historial</span>
                    <span class="sm:hidden">Hist.</span>
                </button>
                <button id="downloadBtn" onclick="downloadExcel()" class="bg-green-600 hover:bg-green-700 text-white px-3 sm:px-6 py-2 sm:py-3 rounded-lg sm:rounded-xl font-semibold transition-all duration-300 hover:transform hover:-translate-y-1 flex items-center justify-center space-x-1 sm:space-x-2 text-sm sm:text-base col-span-2 lg:col-span-1">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span class="hidden sm:inline">Descargar Excel</span>
                    <span class="sm:hidden">Excel</span>
                </button>
            </div>
        </div>

        <!-- Products Table -->
        <div class="bg-white rounded-lg sm:rounded-xl card-shadow overflow-hidden">
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-4 sm:px-6 py-4 sm:py-5 border-b border-gray-200">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-3 sm:space-y-0">
                    <div>
                        <h2 class="text-lg sm:text-xl font-bold text-gray-800">Inventario Actual</h2>
                        <p class="text-xs sm:text-sm text-gray-600 mt-1">Gesti√≥n completa de productos y stock</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="relative flex-1 sm:flex-none">
                            <input type="text" id="searchInput" placeholder="Buscar productos..." class="w-full sm:w-auto pl-8 sm:pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                            <svg class="w-4 h-4 sm:w-5 sm:h-5 text-gray-400 absolute left-2 sm:left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 sm:px-6 py-3 sm:py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Producto</th>
                            <th class="px-3 sm:px-6 py-3 sm:py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider hidden sm:table-cell">Marca</th>
                            <th class="px-3 sm:px-6 py-3 sm:py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Stock</th>
                            <th class="px-3 sm:px-6 py-3 sm:py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider hidden md:table-cell">Unidad</th>
                            <th class="px-3 sm:px-6 py-3 sm:py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider hidden lg:table-cell">M√≠nimo</th>
                            <th class="px-3 sm:px-6 py-3 sm:py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Estado</th>
                            <th class="px-3 sm:px-6 py-3 sm:py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable" class="bg-white divide-y divide-gray-100">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl card-shadow max-w-md w-full mx-4 overflow-hidden">
            <div class="gradient-bg text-white px-8 py-6">
                <h3 class="text-2xl font-bold">Agregar Nuevo Producto</h3>
                <p class="text-blue-100 mt-1">Registra un nuevo material en el inventario</p>
            </div>
            <div class="p-8">
                <form id="addProductForm">

                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Nombre del Producto</label>
                        <input type="text" id="productName" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" placeholder="Ej: Tornillos Phillips">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Marca/Modelo (Opcional)</label>
                        <input type="text" id="productBrand" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" placeholder="Ej: Truper, Stanley, etc.">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Cantidad Inicial</label>
                        <input type="number" id="initialQuantity" required min="0" value="0" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        <p class="text-xs text-gray-500 mt-1">Puedes iniciar en 0 y agregar stock despu√©s con "Registrar Entrada"</p>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Unidad de Medida</label>
                        <select id="unit" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        <option value="">Seleccionar unidad</option>
                        <optgroup label="Unidades B√°sicas">
                            <option value="piezas">Piezas</option>
                            <option value="unidades">Unidades</option>
                            <option value="pares">Pares</option>
                            <option value="juegos">Juegos</option>
                        </optgroup>
                        <optgroup label="Peso">
                            <option value="kg">Kilogramos</option>
                            <option value="gramos">Gramos</option>
                            <option value="toneladas">Toneladas</option>
                            <option value="libras">Libras</option>
                        </optgroup>
                        <optgroup label="Longitud">
                            <option value="metros">Metros</option>
                            <option value="cent√≠metros">Cent√≠metros</option>
                            <option value="mil√≠metros">Mil√≠metros</option>
                            <option value="pulgadas">Pulgadas</option>
                            <option value="pies">Pies</option>
                            <option value="yardas">Yardas</option>
                        </optgroup>
                        <optgroup label="√Årea">
                            <option value="m¬≤">Metros cuadrados</option>
                            <option value="cm¬≤">Cent√≠metros cuadrados</option>
                            <option value="pies¬≤">Pies cuadrados</option>
                        </optgroup>
                        <optgroup label="Volumen">
                            <option value="litros">Litros</option>
                            <option value="mililitros">Mililitros</option>
                            <option value="galones">Galones</option>
                            <option value="m¬≥">Metros c√∫bicos</option>
                        </optgroup>
                        <optgroup label="Empaque">
                            <option value="cajas">Cajas</option>
                            <option value="paquetes">Paquetes</option>
                            <option value="bolsas">Bolsas</option>
                            <option value="rollos">Rollos</option>
                            <option value="tubos">Tubos</option>
                            <option value="l√°minas">L√°minas</option>
                            <option value="placas">Placas</option>
                            <option value="barras">Barras</option>
                            <option value="varillas">Varillas</option>
                            <option value="bobinas">Bobinas</option>
                        </optgroup>
                        <optgroup label="Ferreter√≠a Espec√≠fica">
                            <option value="docenas">Docenas</option>
                            <option value="cientos">Cientos</option>
                            <option value="millares">Millares</option>
                            <option value="sacos">Sacos</option>
                            <option value="bultos">Bultos</option>
                            <option value="tambores">Tambores</option>
                            <option value="bidones">Bidones</option>
                            <option value="cubetas">Cubetas</option>
                            <option value="tarros">Tarros</option>
                            <option value="frascos">Frascos</option>
                        </optgroup>
                            </select>
                    </div>
                    <div class="mb-8">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Stock M√≠nimo</label>
                        <input type="number" id="minStock" required min="0" value="5" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 btn-primary text-white py-3 px-6 rounded-xl font-semibold">
                            Agregar Producto
                        </button>
                        <button type="button" onclick="hideAddProductModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-6 rounded-xl font-semibold transition-all duration-300">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Movement Modal -->
    <div id="movementModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
            <h3 id="movementTitle" class="text-2xl font-bold mb-6 text-gray-800"></h3>
            <form id="movementForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Producto</label>
                    <select id="movementProduct" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Seleccionar producto</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cantidad</label>
                    <input type="number" id="movementQuantity" required min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n (Opcional)</label>
                    <textarea id="movementDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Motivo del movimiento..."></textarea>
                </div>
                <div class="flex gap-4">
                    <button type="submit" id="movementSubmit" class="flex-1 text-white py-2 px-4 rounded-lg font-semibold transition-colors">
                        Registrar
                    </button>
                    <button type="button" onclick="hideMovementModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-semibold transition-colors">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Historial de Movimientos</h3>
                <button onclick="hideHistoryModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <!-- Date Filter Section -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <h4 class="text-sm font-semibold text-gray-700 mb-3">üóìÔ∏è Filtrar por Fechas</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Fecha Desde</label>
                        <input type="date" id="dateFrom" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Fecha Hasta</label>
                        <input type="date" id="dateTo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    </div>
                    <div class="flex items-end space-x-2">
                        <button onclick="applyDateFilter()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm transition-colors">
                            Filtrar
                        </button>
                        <button onclick="clearDateFilter()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium text-sm transition-colors">
                            Limpiar
                        </button>
                    </div>
                </div>
                <div id="filterStatus" class="mt-2 text-xs text-gray-600"></div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Cantidad</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Descripci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable" class="divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Delete Products Modal -->
    <div id="deleteProductsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl card-shadow max-w-2xl w-full mx-4 overflow-hidden max-h-[90vh]">
            <div class="bg-red-600 text-white px-8 py-6">
                <h3 class="text-2xl font-bold">üóëÔ∏è Eliminar Productos</h3>
                <p class="text-red-100 mt-1">Selecciona los productos que deseas eliminar permanentemente</p>
            </div>
            <div class="p-8 overflow-y-auto max-h-[70vh]">
                <div class="mb-6">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                        <div class="flex items-start">
                            <svg class="w-5 h-5 text-red-600 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                            <div>
                                <h4 class="text-red-800 font-semibold">‚ö†Ô∏è Advertencia Importante</h4>
                                <p class="text-red-700 text-sm mt-1">Esta acci√≥n eliminar√° permanentemente los productos seleccionados y registrar√° autom√°ticamente la salida de su stock actual en el historial. Esta operaci√≥n NO se puede deshacer.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between mb-4">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="selectAllProducts" class="rounded border-gray-300 text-red-600 focus:ring-red-500">
                            <span class="text-sm font-medium text-gray-700">Seleccionar todos</span>
                        </label>
                        <span id="selectedCount" class="text-sm text-gray-500">0 productos seleccionados</span>
                    </div>
                </div>
                
                <div id="deleteProductsList" class="space-y-3 mb-6">
                    <!-- Products will be populated here -->
                </div>
                
                <div class="flex gap-4 pt-4 border-t">
                    <button id="confirmDeleteSelected" onclick="confirmDeleteSelectedProducts()" disabled class="flex-1 bg-red-600 hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white py-3 px-6 rounded-xl font-semibold transition-all duration-300">
                        Eliminar Seleccionados
                    </button>
                    <button type="button" onclick="hideDeleteProductsModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-6 rounded-xl font-semibold transition-all duration-300">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Product Modal -->
    <div id="viewProductModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-gray-800">üëÅÔ∏è Ver Producto</h3>
                <span class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm font-medium">üö´ Deshabilitado</span>
            </div>
            <div class="space-y-4">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Producto</label>
                    <div id="viewProductName" class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-700"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Marca/Modelo</label>
                    <div id="viewProductBrand" class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-700"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Stock Actual</label>
                    <div id="viewCurrentStock" class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-700"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Unidad de Medida</label>
                    <div id="viewUnit" class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-700"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Stock M√≠nimo</label>
                    <div id="viewMinStock" class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-700"></div>
                </div>
                <div class="bg-orange-50 border border-orange-200 rounded-lg p-3">
                    <p class="text-orange-800 text-sm">
                        <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Este producto est√° deshabilitado y no aparece en los selectores de movimientos. Para poder editarlo o usarlo nuevamente, primero debes habilitarlo.
                    </p>
                </div>
            </div>
            <div class="flex gap-4 mt-6">
                <button onclick="hideViewProductModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-semibold transition-colors">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editProductModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Editar Producto</h3>
            <form id="editProductForm">
                <input type="hidden" id="editProductId">

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Producto</label>
                    <input type="text" id="editProductName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Marca/Modelo</label>
                    <input type="text" id="editProductBrand" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Stock Actual</label>
                    <input type="number" id="editCurrentStock" readonly class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-600 cursor-not-allowed">
                    <p class="text-xs text-gray-500 mt-1">El stock se modifica √∫nicamente con entradas y salidas</p>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Unidad de Medida</label>
                    <select id="editUnit" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <optgroup label="Unidades B√°sicas">
                            <option value="piezas">Piezas</option>
                            <option value="unidades">Unidades</option>
                            <option value="pares">Pares</option>
                            <option value="juegos">Juegos</option>
                        </optgroup>
                        <optgroup label="Peso">
                            <option value="kg">Kilogramos</option>
                            <option value="gramos">Gramos</option>
                            <option value="toneladas">Toneladas</option>
                            <option value="libras">Libras</option>
                        </optgroup>
                        <optgroup label="Longitud">
                            <option value="metros">Metros</option>
                            <option value="cent√≠metros">Cent√≠metros</option>
                            <option value="mil√≠metros">Mil√≠metros</option>
                            <option value="pulgadas">Pulgadas</option>
                            <option value="pies">Pies</option>
                            <option value="yardas">Yardas</option>
                        </optgroup>
                        <optgroup label="√Årea">
                            <option value="m¬≤">Metros cuadrados</option>
                            <option value="cm¬≤">Cent√≠metros cuadrados</option>
                            <option value="pies¬≤">Pies cuadrados</option>
                        </optgroup>
                        <optgroup label="Volumen">
                            <option value="litros">Litros</option>
                            <option value="mililitros">Mililitros</option>
                            <option value="galones">Galones</option>
                            <option value="m¬≥">Metros c√∫bicos</option>
                        </optgroup>
                        <optgroup label="Empaque">
                            <option value="cajas">Cajas</option>
                            <option value="paquetes">Paquetes</option>
                            <option value="bolsas">Bolsas</option>
                            <option value="rollos">Rollos</option>
                            <option value="tubos">Tubos</option>
                            <option value="l√°minas">L√°minas</option>
                            <option value="placas">Placas</option>
                            <option value="barras">Barras</option>
                            <option value="varillas">Varillas</option>
                            <option value="bobinas">Bobinas</option>
                        </optgroup>
                        <optgroup label="Ferreter√≠a Espec√≠fica">
                            <option value="docenas">Docenas</option>
                            <option value="cientos">Cientos</option>
                            <option value="millares">Millares</option>
                            <option value="sacos">Sacos</option>
                            <option value="bultos">Bultos</option>
                            <option value="tambores">Tambores</option>
                            <option value="bidones">Bidones</option>
                            <option value="cubetas">Cubetas</option>
                            <option value="tarros">Tarros</option>
                            <option value="frascos">Frascos</option>
                        </optgroup>
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Stock M√≠nimo</label>
                    <input type="number" id="editMinStock" required min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-semibold transition-colors">
                        Guardar Cambios
                    </button>
                    <button type="button" onclick="hideEditProductModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-semibold transition-colors">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Data storage
        let products = JSON.parse(localStorage.getItem('inventoryProducts')) || [];
        let movements = JSON.parse(localStorage.getItem('inventoryMovements')) || [];
        let currentMovementType = '';
        let currentUser = null;

        // User roles and authentication
        const users = {
            'admin': { password: 'admin123', role: 'admin', name: 'Administrador' },
            'usuario': { password: 'user123', role: 'user', name: 'Usuario' }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            
            // Login form handler
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                login();
            });
        });

        // Authentication functions
        function checkAuthentication() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
            } else {
                showLoginModal();
            }
        }

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (users[username] && users[username].password === password) {
                currentUser = {
                    username: username,
                    role: users[username].role,
                    name: users[username].name
                };
                
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showMainApp();
                alert(`‚úÖ Bienvenido ${currentUser.name}!`);
            } else {
                alert('‚ùå Usuario o contrase√±a incorrectos');
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            hideMainApp();
            showLoginModal();
        }

        function showLoginModal() {
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('loginModal').classList.add('flex');
        }

        function hideLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('loginModal').classList.remove('flex');
        }

        function showMainApp() {
            hideLoginModal();
            document.getElementById('mainHeader').classList.remove('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            
            // Update user info in header (desktop)
            document.getElementById('currentUser').textContent = currentUser.name;
            document.getElementById('currentRole').textContent = currentUser.role === 'admin' ? 'Administrador' : 'Usuario';
            
            // Update user info in header (mobile)
            document.getElementById('currentUserMobile').textContent = currentUser.name;
            document.getElementById('currentRoleMobile').textContent = currentUser.role === 'admin' ? 'Administrador' : 'Usuario';
            
            // Apply role-based restrictions
            applyRoleRestrictions();
            
            // Initialize app data
            renderProducts();
            checkLowStock();
            updateStats();
            updateLastUpdate();
            
            // Add search functionality
            document.getElementById('searchInput').addEventListener('input', function(e) {
                filterProducts(e.target.value);
            });
        }

        function hideMainApp() {
            document.getElementById('mainHeader').classList.add('hidden');
            document.getElementById('mainContent').classList.add('hidden');
        }

        function applyRoleRestrictions() {
            if (currentUser.role === 'user') {
                // Hide history and download buttons for regular users
                document.getElementById('historyBtn').style.display = 'none';
                document.getElementById('downloadBtn').style.display = 'none';
                
                // Modify grid layout for remaining buttons
                const buttonsContainer = document.querySelector('.grid.grid-cols-2.md\\:grid-cols-4');
                if (buttonsContainer) {
                    buttonsContainer.className = 'grid grid-cols-2 md:grid-cols-2 gap-4';
                }
            } else {
                // Show all buttons for admin
                document.getElementById('historyBtn').style.display = 'flex';
                document.getElementById('downloadBtn').style.display = 'flex';
            }
        }

        // Excel download function with text fallback
        function downloadExcel() {
            // Close any open modals first for quick action
            hideHistoryModal();
            hideAddProductModal();
            hideMovementModal();
            hideEditProductModal();
            hideDeleteProductsModal();
            hideViewProductModal();

            if (currentUser.role !== 'admin') {
                alert('‚ùå No tienes permisos para descargar el historial');
                return;
            }

            if (movements.length === 0) {
                alert('‚ö†Ô∏è No hay movimientos para descargar');
                return;
            }

            // Show loading indicator
            const originalText = document.querySelector('#downloadBtn span').textContent;
            document.querySelector('#downloadBtn span').textContent = 'Generando...';
            document.getElementById('downloadBtn').disabled = true;

            try {
                // Try Excel download first
                if (typeof XLSX !== 'undefined') {
                    downloadExcelFile();
                } else {
                    // Fallback to text export
                    exportAsText();
                }
            } catch (error) {
                console.error('Error in download:', error);
                // Try text fallback on any error
                exportAsText();
            }
        }

        function downloadExcelFile() {
            try {
                // Sort movements by date (newest first) for better organization
                const sortedMovements = [...movements].sort((a, b) => new Date(b.date) - new Date(a.date));

                // Prepare detailed data for Excel
                const excelData = sortedMovements.map((movement, index) => {
                    let date;
                    try {
                        date = new Date(movement.date);
                        if (isNaN(date.getTime())) {
                            date = new Date();
                        }
                    } catch (e) {
                        date = new Date();
                    }

                    // Find product details for additional info
                    const product = products.find(p => p.id === movement.productId);
                    const productUnit = product ? product.unit : 'unidades';
                    const productMinStock = product ? product.minStock : 'N/A';
                    const currentStock = product ? product.currentStock : 'N/A';
                    
                    return {
                        'No.': index + 1,
                        'Fecha': date.toLocaleDateString('es-ES', { 
                            year: 'numeric', 
                            month: '2-digit', 
                            day: '2-digit' 
                        }),
                        'Hora': date.toLocaleTimeString('es-ES', { 
                            hour: '2-digit', 
                            minute: '2-digit', 
                            second: '2-digit' 
                        }),
                        'D√≠a de la Semana': date.toLocaleDateString('es-ES', { weekday: 'long' }),
                        'Producto': movement.productName || 'Sin nombre',
                        'Tipo de Movimiento': movement.type === 'entrada' ? 'ENTRADA' : 'SALIDA',
                        'Cantidad': movement.quantity || 0,
                        'Unidad de Medida': productUnit,
                        'Descripci√≥n/Motivo': movement.description || 'Sin descripci√≥n',
                        'Stock Actual del Producto': currentStock,
                        'Stock M√≠nimo': productMinStock,
                        'Estado del Stock': product && product.currentStock <= product.minStock ? 'BAJO' : 'NORMAL',
                        'ID Movimiento': movement.id,
                        'ID Producto': movement.productId || 'N/A'
                    };
                });

                // Create workbook
                const wb = XLSX.utils.book_new();

                // Create main worksheet with all movements
                const ws = XLSX.utils.json_to_sheet(excelData);

                // Set column widths for better readability
                const colWidths = [
                    { wch: 6 },  // No.
                    { wch: 12 }, // Fecha
                    { wch: 10 }, // Hora
                    { wch: 15 }, // D√≠a de la Semana
                    { wch: 35 }, // Producto
                    { wch: 18 }, // Tipo de Movimiento
                    { wch: 10 }, // Cantidad
                    { wch: 15 }, // Unidad de Medida
                    { wch: 45 }, // Descripci√≥n/Motivo
                    { wch: 15 }, // Stock Actual
                    { wch: 12 }, // Stock M√≠nimo
                    { wch: 12 }, // Estado del Stock
                    { wch: 15 }, // ID Movimiento
                    { wch: 12 }  // ID Producto
                ];
                ws['!cols'] = colWidths;

                // Add main worksheet
                XLSX.utils.book_append_sheet(wb, ws, 'Historial Completo');

                // Create separate worksheets for entries and exits
                const entradas = excelData.filter(item => item['Tipo de Movimiento'] === 'ENTRADA');
                const salidas = excelData.filter(item => item['Tipo de Movimiento'] === 'SALIDA');

                if (entradas.length > 0) {
                    const wsEntradas = XLSX.utils.json_to_sheet(entradas);
                    wsEntradas['!cols'] = colWidths;
                    XLSX.utils.book_append_sheet(wb, wsEntradas, 'Solo Entradas');
                }

                if (salidas.length > 0) {
                    const wsSalidas = XLSX.utils.json_to_sheet(salidas);
                    wsSalidas['!cols'] = colWidths;
                    XLSX.utils.book_append_sheet(wb, wsSalidas, 'Solo Salidas');
                }

                // Create summary worksheet
                const summaryData = [
                    { 'Concepto': 'Total de Movimientos', 'Valor': movements.length },
                    { 'Concepto': 'Total de Entradas', 'Valor': entradas.length },
                    { 'Concepto': 'Total de Salidas', 'Valor': salidas.length },
                    { 'Concepto': 'Productos Registrados', 'Valor': products.length },
                    { 'Concepto': 'Productos con Stock Bajo', 'Valor': products.filter(p => p.currentStock <= p.minStock).length },
                    { 'Concepto': 'Fecha de Generaci√≥n', 'Valor': new Date().toLocaleString('es-ES') },
                    { 'Concepto': 'Usuario que Descarga', 'Valor': currentUser.name },
                    { 'Concepto': 'Rol del Usuario', 'Valor': currentUser.role === 'admin' ? 'Administrador' : 'Usuario' }
                ];

                const wsSummary = XLSX.utils.json_to_sheet(summaryData);
                wsSummary['!cols'] = [{ wch: 25 }, { wch: 30 }];
                XLSX.utils.book_append_sheet(wb, wsSummary, 'Resumen');

                // Generate filename with current date and time
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}`;
                const timeStr = `${now.getHours().toString().padStart(2,'0')}-${now.getMinutes().toString().padStart(2,'0')}`;
                const filename = `Inventario_Historial_Completo_${dateStr}_${timeStr}.xlsx`;

                // Generate Excel file as binary
                const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                
                // Create blob with proper MIME type for Excel
                const blob = new Blob([excelBuffer], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                });
                
                // Create download URL
                const url = URL.createObjectURL(blob);
                
                // For Android Chrome - Open in new tab with immediate download
                if (/Android/i.test(navigator.userAgent)) {
                    // Create a new window/tab that will trigger the download
                    const newWindow = window.open('', '_blank');
                    if (newWindow) {
                        newWindow.document.write(`
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <title>Descargando Excel...</title>
                                <meta charset="UTF-8">
                                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                                <style>
                                    body { 
                                        font-family: Arial, sans-serif; 
                                        text-align: center; 
                                        padding: 20px; 
                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                        color: white;
                                        margin: 0;
                                    }
                                    .container { 
                                        max-width: 400px; 
                                        margin: 50px auto; 
                                        background: white; 
                                        color: #333; 
                                        padding: 30px; 
                                        border-radius: 15px; 
                                        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                                    }
                                    .spinner { 
                                        border: 4px solid #f3f3f3; 
                                        border-top: 4px solid #667eea; 
                                        border-radius: 50%; 
                                        width: 50px; 
                                        height: 50px; 
                                        animation: spin 1s linear infinite; 
                                        margin: 20px auto; 
                                    }
                                    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                                    .download-btn { 
                                        background: #667eea; 
                                        color: white; 
                                        border: none; 
                                        padding: 15px 30px; 
                                        border-radius: 8px; 
                                        font-size: 16px; 
                                        cursor: pointer; 
                                        margin: 10px; 
                                        text-decoration: none;
                                        display: inline-block;
                                    }
                                    .download-btn:hover { background: #5a6fd8; }
                                    .info { 
                                        background: #e8f4fd; 
                                        border: 1px solid #bee5eb; 
                                        padding: 15px; 
                                        border-radius: 8px; 
                                        margin: 20px 0; 
                                        font-size: 14px;
                                    }
                                </style>
                            </head>
                            <body>
                                <div class="container">
                                    <h2>üìä Descarga de Excel</h2>
                                    <div class="spinner"></div>
                                    <p>Preparando tu archivo Excel...</p>
                                    <div class="info">
                                        <strong>üìÅ Archivo:</strong> ${filename}<br>
                                        <strong>üìä Contenido:</strong> ${movements.length} movimientos<br>
                                        <strong>üì± Dispositivo:</strong> Android Chrome
                                    </div>
                                    <a href="${url}" download="${filename}" class="download-btn" id="downloadLink">
                                        üì• Descargar Excel
                                    </a>
                                    <p style="font-size: 12px; color: #666; margin-top: 20px;">
                                        Si la descarga no inicia autom√°ticamente, presiona el bot√≥n de arriba.
                                    </p>
                                </div>
                                <script>
                                    // Auto-trigger download after a short delay
                                    setTimeout(function() {
                                        document.getElementById('downloadLink').click();
                                    }, 1500);
                                    
                                    // Clean up after download
                                    setTimeout(function() {
                                        window.close();
                                    }, 5000);
                                </script>
                            <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98a1e1137719a51e',t:'MTc1OTcxOTMxOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
                            </html>
                        `);
                        newWindow.document.close();
                    } else {
                        // Fallback if popup blocked
                        const downloadLink = document.createElement('a');
                        downloadLink.href = url;
                        downloadLink.download = filename;
                        downloadLink.click();
                    }
                } else {
                    // For desktop and other browsers - direct download
                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;
                    downloadLink.download = filename;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                }
                
                // Show success message
                setTimeout(() => {
                    alert(`‚úÖ ¬°Descarga Excel iniciada!\n\nüìä Detalles del archivo:\n‚Ä¢ ${movements.length} movimientos totales\n‚Ä¢ ${entradas.length} entradas registradas\n‚Ä¢ ${salidas.length} salidas registradas\n‚Ä¢ 4 hojas de c√°lculo incluidas\n\nüìÅ Archivo: ${filename}\n\nüåê Se abri√≥ una nueva pesta√±a para la descarga en Chrome.`);
                    
                    // Restore button
                    document.querySelector('#downloadBtn span').textContent = document.querySelector('#downloadBtn span').textContent.includes('Excel') ? 'Descargar Excel' : 'Excel';
                    document.getElementById('downloadBtn').disabled = false;
                }, 500);
                
                // Clean up URL after delay
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 10000);
                
            } catch (error) {
                console.error('Error generating Excel:', error);
                // Fallback to text export
                exportAsText();
            }
        }

        function exportAsText() {
            try {
                // Sort movements by date (newest first)
                const sortedMovements = [...movements].sort((a, b) => new Date(b.date) - new Date(a.date));

                // Generate comprehensive text report
                let textReport = `SISTEMA DE INVENTARIO - HISTORIAL COMPLETO\n`;
                textReport += `${'='.repeat(60)}\n\n`;
                
                // Summary section
                textReport += `üìä RESUMEN GENERAL\n`;
                textReport += `${'-'.repeat(30)}\n`;
                textReport += `Total de Movimientos: ${movements.length}\n`;
                textReport += `Total de Entradas: ${movements.filter(m => m.type === 'entrada').length}\n`;
                textReport += `Total de Salidas: ${movements.filter(m => m.type === 'salida').length}\n`;
                textReport += `Productos Registrados: ${products.length}\n`;
                textReport += `Productos con Stock Bajo: ${products.filter(p => p.currentStock <= p.minStock).length}\n`;
                textReport += `Fecha de Generaci√≥n: ${new Date().toLocaleString('es-ES')}\n`;
                textReport += `Usuario: ${currentUser.name} (${currentUser.role === 'admin' ? 'Administrador' : 'Usuario'})\n\n`;

                // Detailed movements section
                textReport += `üìã HISTORIAL DETALLADO DE MOVIMIENTOS\n`;
                textReport += `${'-'.repeat(50)}\n\n`;

                sortedMovements.forEach((movement, index) => {
                    let date;
                    try {
                        date = new Date(movement.date);
                        if (isNaN(date.getTime())) {
                            date = new Date();
                        }
                    } catch (e) {
                        date = new Date();
                    }

                    const product = products.find(p => p.id === movement.productId);
                    const productUnit = product ? product.unit : 'unidades';
                    const currentStock = product ? product.currentStock : 'N/A';
                    const minStock = product ? product.minStock : 'N/A';
                    const stockStatus = product && product.currentStock <= product.minStock ? 'BAJO' : 'NORMAL';

                    textReport += `${index + 1}. ${movement.type === 'entrada' ? 'üì• ENTRADA' : 'üì§ SALIDA'}\n`;
                    textReport += `   Fecha: ${date.toLocaleDateString('es-ES')} ${date.toLocaleTimeString('es-ES')}\n`;
                    textReport += `   D√≠a: ${date.toLocaleDateString('es-ES', { weekday: 'long' })}\n`;
                    textReport += `   Producto: ${movement.productName || 'Sin nombre'}\n`;
                    textReport += `   Cantidad: ${movement.quantity || 0} ${productUnit}\n`;
                    textReport += `   Descripci√≥n: ${movement.description || 'Sin descripci√≥n'}\n`;
                    textReport += `   Stock Actual: ${currentStock} (M√≠nimo: ${minStock}) - Estado: ${stockStatus}\n`;
                    textReport += `   IDs: Movimiento=${movement.id}, Producto=${movement.productId || 'N/A'}\n\n`;
                });

                // Products section
                textReport += `üì¶ PRODUCTOS ACTUALES\n`;
                textReport += `${'-'.repeat(30)}\n\n`;
                
                products.forEach((product, index) => {
                    const stockStatus = product.currentStock <= product.minStock ? '‚ö†Ô∏è STOCK BAJO' : '‚úÖ NORMAL';
                    const status = product.disabled ? 'üö´ DESHABILITADO' : '‚úÖ ACTIVO';
                    
                    textReport += `${index + 1}. ${product.name}${product.brand ? ` (${product.brand})` : ''}\n`;
                    textReport += `   Stock: ${product.currentStock} ${product.unit}\n`;
                    textReport += `   M√≠nimo: ${product.minStock}\n`;
                    textReport += `   Estado Stock: ${stockStatus}\n`;
                    textReport += `   Estado Producto: ${status}\n`;
                    textReport += `   ID: ${product.id}\n\n`;
                });

                textReport += `${'-'.repeat(60)}\n`;
                textReport += `Fin del reporte - Generado autom√°ticamente por Sistema de Inventario\n`;

                // Try to download as file first
                try {
                    const blob = new Blob([textReport], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    const now = new Date();
                    const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}`;
                    const timeStr = `${now.getHours().toString().padStart(2,'0')}-${now.getMinutes().toString().padStart(2,'0')}`;
                    a.download = `Inventario_Historial_${dateStr}_${timeStr}.txt`;
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    setTimeout(() => {
                        alert(`‚úÖ ¬°Descarga de texto completada!\n\nüìÑ Se descarg√≥ un archivo de texto con:\n‚Ä¢ ${movements.length} movimientos detallados\n‚Ä¢ ${products.length} productos actuales\n‚Ä¢ Resumen completo del sistema\n\nüí° Si no se descarg√≥ autom√°ticamente, usa la opci√≥n "Copiar Texto" que aparecer√° a continuaci√≥n.`);
                        
                        // Restore button
                        document.querySelector('#downloadBtn span').textContent = document.querySelector('#downloadBtn span').textContent.includes('Excel') ? 'Descargar Excel' : 'Excel';
                        document.getElementById('downloadBtn').disabled = false;
                    }, 500);

                } catch (downloadError) {
                    console.log('File download failed, showing copy option:', downloadError);
                    showCopyTextModal(textReport);
                }

            } catch (error) {
                console.error('Error generating text report:', error);
                alert('‚ùå Error al generar el reporte de texto: ' + error.message);
                
                // Restore button on error
                document.querySelector('#downloadBtn span').textContent = document.querySelector('#downloadBtn span').textContent.includes('Excel') ? 'Descargar Excel' : 'Excel';
                document.getElementById('downloadBtn').disabled = false;
            }
        }

        function showCopyTextModal(textContent) {
            // Create modal dynamically
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">üìÑ Historial Completo - Copiar Texto</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <p class="text-blue-800 text-sm">
                            <strong>üí° Instrucciones:</strong> El texto completo est√° seleccionado abajo. Usa Ctrl+C (o Cmd+C en Mac) para copiarlo, 
                            luego p√©galo en un archivo de texto, Word, o donde necesites.
                        </p>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <textarea readonly class="w-full h-full p-4 border border-gray-300 rounded-lg font-mono text-sm resize-none focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                  onclick="this.select()" id="copyTextArea">${textContent}</textarea>
                    </div>
                    <div class="flex gap-4 mt-4">
                        <button onclick="copyToClipboard()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-semibold transition-colors">
                            üìã Copiar al Portapapeles
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-semibold transition-colors">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto-select text
            setTimeout(() => {
                const textarea = document.getElementById('copyTextArea');
                textarea.select();
                textarea.focus();
            }, 100);

            // Restore download button
            document.querySelector('#downloadBtn span').textContent = document.querySelector('#downloadBtn span').textContent.includes('Excel') ? 'Descargar Excel' : 'Excel';
            document.getElementById('downloadBtn').disabled = false;
        }

        function copyToClipboard() {
            const textarea = document.getElementById('copyTextArea');
            textarea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert('‚úÖ ¬°Texto copiado al portapapeles exitosamente!\n\nYa puedes pegarlo donde necesites.');
                } else {
                    alert('‚ö†Ô∏è No se pudo copiar autom√°ticamente. Por favor, selecciona todo el texto y usa Ctrl+C (o Cmd+C en Mac).');
                }
            } catch (err) {
                console.error('Error copying to clipboard:', err);
                alert('‚ö†Ô∏è No se pudo copiar autom√°ticamente. Por favor, selecciona todo el texto y usa Ctrl+C (o Cmd+C en Mac).');
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('inventoryProducts', JSON.stringify(products));
            localStorage.setItem('inventoryMovements', JSON.stringify(movements));
            updateStats();
            updateLastUpdate();
        }

        // Update statistics
        function updateStats() {
            document.getElementById('totalProducts').textContent = products.length;
            
            const lowStockProducts = products.filter(p => p.currentStock <= p.minStock);
            document.getElementById('lowStockCount').textContent = lowStockProducts.length;
            
            // Get today's date in YYYY-MM-DD format for comparison
            const today = new Date().toISOString().split('T')[0];
            const todayMovements = movements.filter(m => {
                try {
                    // Handle both ISO format and locale format dates
                    let movementDate;
                    if (m.date.includes('T')) {
                        // ISO format
                        movementDate = m.date.split('T')[0];
                    } else {
                        // Locale format - convert to ISO
                        const parsedDate = new Date(m.date);
                        if (!isNaN(parsedDate.getTime())) {
                            movementDate = parsedDate.toISOString().split('T')[0];
                        } else {
                            return false;
                        }
                    }
                    return movementDate === today;
                } catch (e) {
                    console.error('Error parsing date:', m.date, e);
                    return false;
                }
            });
            
            const todayEntries = todayMovements.filter(m => m.type === 'entrada').reduce((sum, m) => sum + m.quantity, 0);
            const todayExits = todayMovements.filter(m => m.type === 'salida').reduce((sum, m) => sum + m.quantity, 0);
            
            document.getElementById('todayEntries').textContent = todayEntries;
            document.getElementById('todayExits').textContent = todayExits;
        }

        // Update last update time
        function updateLastUpdate() {
            const now = new Date();
            const timeString = now.toLocaleString('es-ES');
            document.getElementById('lastUpdate').textContent = timeString;
            document.getElementById('lastUpdateMobile').textContent = now.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // Filter products
        function filterProducts(searchTerm) {
            const rows = document.querySelectorAll('#productsTable tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 0) {
                    const productName = cells[0]?.textContent.toLowerCase() || '';
                    const productBrand = cells[1]?.textContent.toLowerCase() || '';
                    
                    const searchLower = searchTerm.toLowerCase();
                    if (productName.includes(searchLower) || 
                        productBrand.includes(searchLower)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
        }

        // Add Product Modal Functions
        function showAddProductModal() {
            document.getElementById('addProductModal').classList.remove('hidden');
            document.getElementById('addProductModal').classList.add('flex');
        }

        function hideAddProductModal() {
            document.getElementById('addProductModal').classList.add('hidden');
            document.getElementById('addProductModal').classList.remove('flex');
            document.getElementById('addProductForm').reset();
        }

        // Add Product Form Handler
        document.getElementById('addProductForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('productName').value;
            const brand = document.getElementById('productBrand').value;
            const quantity = parseInt(document.getElementById('initialQuantity').value);
            const unit = document.getElementById('unit').value;
            const minStock = parseInt(document.getElementById('minStock').value);

            const newProduct = {
                id: Date.now(),
                name: name,
                brand: brand || '',
                currentStock: quantity,
                unit: unit,
                minStock: minStock,
                disabled: false
            };

            products.push(newProduct);
            
            // Add initial movement only if quantity > 0
            if (quantity > 0) {
                movements.push({
                    id: Date.now(),
                    productId: newProduct.id,
                    productName: brand ? `${name} (${brand})` : name,
                    type: 'entrada',
                    quantity: quantity,
                    description: 'Stock inicial',
                    date: new Date().toISOString()
                });
            }

            saveData();
            renderProducts();
            checkLowStock();
            hideAddProductModal();
            
            alert('‚úÖ Producto agregado exitosamente');
        });

        // Movement Modal Functions
        function showMovementModal(type) {
            if (products.length === 0) {
                alert('‚ö†Ô∏è Primero debes agregar productos al inventario');
                return;
            }

            currentMovementType = type;
            const modal = document.getElementById('movementModal');
            const title = document.getElementById('movementTitle');
            const submitBtn = document.getElementById('movementSubmit');
            
            if (type === 'entrada') {
                title.textContent = 'üì• Registrar Entrada de Material';
                submitBtn.textContent = 'Registrar Entrada';
                submitBtn.className = 'flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-semibold transition-colors';
            } else {
                title.textContent = 'üì§ Registrar Salida de Material';
                submitBtn.textContent = 'Registrar Salida';
                submitBtn.className = 'flex-1 bg-orange-600 hover:bg-orange-700 text-white py-2 px-4 rounded-lg font-semibold transition-colors';
            }

            populateProductSelect();
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideMovementModal() {
            document.getElementById('movementModal').classList.add('hidden');
            document.getElementById('movementModal').classList.remove('flex');
            document.getElementById('movementForm').reset();
        }

        function populateProductSelect() {
            const select = document.getElementById('movementProduct');
            select.innerHTML = '<option value="">Seleccionar producto</option>';
            
            // Only show enabled products
            const enabledProducts = products.filter(product => !product.disabled);
            
            if (enabledProducts.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay productos habilitados disponibles';
                option.disabled = true;
                select.appendChild(option);
                return;
            }
            
            enabledProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                let displayName = product.name;
                if (product.brand) {
                    displayName += ` (${product.brand})`;
                }
                option.textContent = `${displayName} - Stock: ${product.currentStock} ${product.unit}`;
                select.appendChild(option);
            });
        }

        // Movement Form Handler
        document.getElementById('movementForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productId = parseInt(document.getElementById('movementProduct').value);
            const quantity = parseInt(document.getElementById('movementQuantity').value);
            const description = document.getElementById('movementDescription').value;
            
            const product = products.find(p => p.id === productId);
            
            if (currentMovementType === 'salida' && quantity > product.currentStock) {
                alert('‚ùå No hay suficiente stock disponible');
                return;
            }

            // Update product stock
            if (currentMovementType === 'entrada') {
                product.currentStock += quantity;
            } else {
                product.currentStock -= quantity;
            }

            // Add movement record
            const displayName = product.brand ? `${product.name} (${product.brand})` : product.name;
            movements.push({
                id: Date.now(),
                productId: productId,
                productName: displayName,
                type: currentMovementType,
                quantity: quantity,
                description: description || `${currentMovementType === 'entrada' ? 'Entrada' : 'Salida'} de material`,
                date: new Date().toISOString()
            });

            // Save and update everything
            saveData();
            renderProducts();
            checkLowStock();
            updateStats();
            hideMovementModal();
            
            const message = currentMovementType === 'entrada' ? 
                '‚úÖ Entrada registrada exitosamente' : 
                '‚úÖ Salida registrada exitosamente';
            alert(message);
        });

        // Edit Product Functions
        function confirmEditProduct(productId) {
            showEditProductModal(productId);
        }

        function showEditProductModal(productId) {
            const product = products.find(p => p.id === productId);
            
            document.getElementById('editProductId').value = product.id;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductBrand').value = product.brand || '';
            document.getElementById('editCurrentStock').value = product.currentStock;
            document.getElementById('editUnit').value = product.unit;
            document.getElementById('editMinStock').value = product.minStock;
            
            document.getElementById('editProductModal').classList.remove('hidden');
            document.getElementById('editProductModal').classList.add('flex');
        }

        function hideEditProductModal() {
            document.getElementById('editProductModal').classList.add('hidden');
            document.getElementById('editProductModal').classList.remove('flex');
        }

        // Edit Product Form Handler
        document.getElementById('editProductForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productId = parseInt(document.getElementById('editProductId').value);
            const product = products.find(p => p.id === productId);
            
            product.name = document.getElementById('editProductName').value;
            product.brand = document.getElementById('editProductBrand').value;
            // Stock is not editable - only modified through entries/exits
            product.unit = document.getElementById('editUnit').value;
            product.minStock = parseInt(document.getElementById('editMinStock').value);

            saveData();
            renderProducts();
            checkLowStock();
            hideEditProductModal();
            
            alert('‚úÖ Producto actualizado exitosamente');
        });

        // Delete Products Modal Functions
        function showDeleteProductsModal() {
            if (products.length === 0) {
                alert('‚ö†Ô∏è No hay productos para eliminar');
                return;
            }
            
            populateDeleteProductsList();
            document.getElementById('deleteProductsModal').classList.remove('hidden');
            document.getElementById('deleteProductsModal').classList.add('flex');
        }

        function hideDeleteProductsModal() {
            document.getElementById('deleteProductsModal').classList.add('hidden');
            document.getElementById('deleteProductsModal').classList.remove('flex');
            
            // Reset selections
            document.getElementById('selectAllProducts').checked = false;
            updateSelectedCount();
        }

        function populateDeleteProductsList() {
            const container = document.getElementById('deleteProductsList');
            container.innerHTML = '';
            
            if (products.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay productos disponibles</p>';
                return;
            }
            
            products.forEach(product => {
                const displayName = product.brand ? `${product.name} (${product.brand})` : product.name;
                const isLowStock = product.currentStock <= product.minStock;
                
                const productDiv = document.createElement('div');
                productDiv.className = `border rounded-lg p-4 hover:bg-gray-50 transition-colors ${isLowStock ? 'border-red-200 bg-red-50' : 'border-gray-200'}`;
                
                productDiv.innerHTML = `
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" class="product-checkbox rounded border-gray-300 text-red-600 focus:ring-red-500" data-product-id="${product.id}">
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-semibold text-gray-900">${displayName}</h4>
                                    <p class="text-sm text-gray-600">Stock actual: ${product.currentStock} ${product.unit}</p>
                                    ${isLowStock ? '<span class="text-xs text-red-600 font-medium">‚ö†Ô∏è Stock bajo</span>' : ''}
                                </div>
                                <div class="text-right">
                                    <span class="text-sm text-gray-500">M√≠n: ${product.minStock}</span>
                                </div>
                            </div>
                        </div>
                    </label>
                `;
                
                container.appendChild(productDiv);
            });
            
            // Add event listeners to checkboxes
            const checkboxes = container.querySelectorAll('.product-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedCount);
            });
            
            // Add event listener to select all checkbox
            document.getElementById('selectAllProducts').addEventListener('change', function() {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateSelectedCount();
            });
            
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.product-checkbox');
            const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
            const count = selectedCheckboxes.length;
            
            document.getElementById('selectedCount').textContent = `${count} productos seleccionados`;
            document.getElementById('confirmDeleteSelected').disabled = count === 0;
            
            // Update select all checkbox state
            const selectAllCheckbox = document.getElementById('selectAllProducts');
            if (count === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (count === checkboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
            }
        }

        function confirmDeleteSelectedProducts() {
            const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.productId));
            
            if (selectedIds.length === 0) {
                alert('‚ö†Ô∏è No hay productos seleccionados');
                return;
            }
            
            deleteSelectedProducts(selectedIds);
        }

        function deleteSelectedProducts(productIds) {
            try {
                let deletedCount = 0;
                let totalMovementsDeleted = 0;
                
                productIds.forEach(productId => {
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        // Contar movimientos que se van a eliminar
                        const productMovements = movements.filter(m => m.productId === productId);
                        totalMovementsDeleted += productMovements.length;
                        
                        deletedCount++;
                    }
                });
                
                // Eliminar los productos del array
                products = products.filter(p => !productIds.includes(p.id));
                
                // Eliminar TODOS los movimientos relacionados con estos productos
                movements = movements.filter(m => !productIds.includes(m.productId));
                
                // Guardar datos
                saveData();
                renderProducts();
                checkLowStock();
                hideDeleteProductsModal();
                
                alert(`‚úÖ ${deletedCount} producto(s) eliminado(s) completamente del sistema.\nüìã Se eliminaron ${totalMovementsDeleted} registros del historial.`);
                
            } catch (error) {
                console.error('Error eliminando productos:', error);
                alert('‚ùå Error al eliminar los productos. Por favor, intenta de nuevo.');
            }
        }

        // Delete Product Functions (Individual)
        function confirmDeleteProduct(productId) {
            deleteProduct(productId);
        }

        // Funci√≥n para eliminar un producto por su id
        function deleteProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                alert('‚ùå Error: Producto no encontrado');
                return;
            }
            
            const displayName = product.brand ? `${product.name} (${product.brand})` : product.name;
            
            try {
                // Eliminar el producto del array
                products = products.filter(p => p.id !== productId);
                
                // Eliminar TODOS los movimientos relacionados con este producto
                movements = movements.filter(m => m.productId !== productId);
                
                // Guardar cambios
                saveData();
                renderProducts();
                checkLowStock();
                
                alert(`‚úÖ Producto "${displayName}" eliminado completamente del sistema.`);
                
            } catch (error) {
                console.error('Error eliminando producto:', error);
                alert('‚ùå Error al eliminar el producto. Por favor, intenta de nuevo.');
            }
        }

        // Render Products Table
        function renderProducts() {
            const tbody = document.getElementById('productsTable');
            tbody.innerHTML = '';

            if (products.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                            No hay productos en el inventario. ¬°Agrega tu primer producto!
                        </td>
                    </tr>
                `;
                return;
            }

            products.forEach(product => {
                const isLowStock = product.currentStock <= product.minStock;
                const isDisabled = product.disabled || false;

                let statusClass, statusText, rowClass;
                if (isDisabled) {
                    statusClass = 'bg-gray-100 text-gray-800';
                    statusText = 'üö´ Deshabilitado';
                    rowClass = 'bg-gray-100 opacity-60';
                } else if (isLowStock) {
                    statusClass = 'bg-red-100 text-red-800';
                    statusText = '‚ö†Ô∏è Stock Bajo';
                    rowClass = 'bg-red-50';
                } else {
                    statusClass = 'bg-green-100 text-green-800';
                    statusText = '‚úÖ Normal';
                    rowClass = '';
                }

                const tr = document.createElement('tr');
                tr.className = `${rowClass} hover:bg-gray-50 transition-colors duration-200`;

                tr.innerHTML = `
                    <td class="px-3 sm:px-6 py-3 sm:py-5 whitespace-nowrap">
                        <div class="flex flex-col sm:flex-row sm:items-center">
                            <div>
                                <div class="text-sm font-semibold text-gray-900">${product.name}</div>
                                <div class="text-xs text-gray-500 sm:hidden">${product.brand || 'Sin marca'}</div>
                                <div class="text-xs text-gray-500 md:hidden">${product.unit} | M√≠n: ${product.minStock}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-3 sm:px-6 py-3 sm:py-5 hidden sm:table-cell">${product.brand || '-'}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-5 font-semibold">${product.currentStock}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-5 hidden md:table-cell">${product.unit}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-5 hidden lg:table-cell">${product.minStock}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-5"><span class="status-badge ${statusClass}">${statusText}</span></td>
                `;

                const actionsTd = document.createElement('td');
                actionsTd.className = "px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-sm font-medium";
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = "flex flex-col sm:flex-row items-stretch sm:items-center space-y-1 sm:space-y-0 sm:space-x-2";

                const editBtn = document.createElement('button');
                editBtn.innerHTML = `
                    <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                        </path>
                    </svg>
                    <span class="hidden sm:inline ml-1">Editar</span>
                `;
                editBtn.className = "bg-blue-600 hover:bg-blue-700 text-white px-2 sm:px-3 py-1 sm:py-2 rounded text-xs sm:text-sm transition-all duration-200 flex items-center justify-center";
                editBtn.addEventListener('click', () => showEditProductModal(product.id));

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = `
                    <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 
                                 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                        </path>
                    </svg>
                    <span class="hidden sm:inline ml-1">Eliminar</span>
                `;
                deleteBtn.className = "bg-red-600 hover:bg-red-700 text-white px-2 sm:px-3 py-1 sm:py-2 rounded text-xs sm:text-sm transition-all duration-200 flex items-center justify-center";
                deleteBtn.addEventListener('click', () => confirmDeleteProduct(product.id));

                actionsDiv.appendChild(editBtn);
                actionsDiv.appendChild(deleteBtn);
                actionsTd.appendChild(actionsDiv);

                tr.appendChild(actionsTd);
                tbody.appendChild(tr);
            });
        }

        // Check Low Stock and Show Alerts
        function checkLowStock() {
            const alertsContainer = document.getElementById('alertsContainer');
            const lowStockProducts = products.filter(p => p.currentStock <= p.minStock);

            if (lowStockProducts.length === 0) {
                alertsContainer.innerHTML = '';
                return;
            }

            alertsContainer.innerHTML = `
                <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg alert-pulse">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <span class="text-2xl">‚ö†Ô∏è</span>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium">
                                ¬°Alerta de Stock Bajo! Los siguientes materiales est√°n agot√°ndose:
                            </p>
                            <ul class="mt-2 text-sm">
                                ${lowStockProducts.map(p => 
                                    `<li>‚Ä¢ <strong>${p.name}</strong>: ${p.currentStock} ${p.unit} (m√≠nimo: ${p.minStock})</li>`
                                ).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        // History Modal Functions
        function showHistoryModal() {
            if (currentUser.role !== 'admin') {
                alert('‚ùå No tienes permisos para ver el historial');
                return;
            }
            renderHistory();
            document.getElementById('historyModal').classList.remove('hidden');
            document.getElementById('historyModal').classList.add('flex');
        }

        function hideHistoryModal() {
            document.getElementById('historyModal').classList.add('hidden');
            document.getElementById('historyModal').classList.remove('flex');
        }

        // Date filter variables
        let filteredMovements = [];
        let isDateFilterActive = false;

        function applyDateFilter() {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            if (!dateFrom && !dateTo) {
                alert('‚ö†Ô∏è Por favor selecciona al menos una fecha para filtrar');
                return;
            }
            
            let filtered = [...movements];
            let filterCount = 0;
            
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                fromDate.setHours(0, 0, 0, 0);
                filtered = filtered.filter(movement => {
                    const movementDate = new Date(movement.date);
                    movementDate.setHours(0, 0, 0, 0);
                    return movementDate >= fromDate;
                });
                filterCount++;
            }
            
            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999);
                filtered = filtered.filter(movement => {
                    const movementDate = new Date(movement.date);
                    return movementDate <= toDate;
                });
                filterCount++;
            }
            
            filteredMovements = filtered;
            isDateFilterActive = true;
            
            // Update filter status
            const statusDiv = document.getElementById('filterStatus');
            let statusText = `üìä Mostrando ${filtered.length} de ${movements.length} movimientos`;
            if (dateFrom && dateTo) {
                statusText += ` entre ${dateFrom} y ${dateTo}`;
            } else if (dateFrom) {
                statusText += ` desde ${dateFrom}`;
            } else if (dateTo) {
                statusText += ` hasta ${dateTo}`;
            }
            statusDiv.textContent = statusText;
            
            renderHistory();
        }

        function clearDateFilter() {
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('filterStatus').textContent = '';
            isDateFilterActive = false;
            filteredMovements = [];
            renderHistory();
        }

        function renderHistory() {
            const tbody = document.getElementById('historyTable');
            tbody.innerHTML = '';

            // Use filtered movements if filter is active, otherwise use all movements
            const movementsToShow = isDateFilterActive ? filteredMovements : movements;

            if (movementsToShow.length === 0) {
                const message = isDateFilterActive ? 
                    'No hay movimientos en el rango de fechas seleccionado' : 
                    'No hay movimientos registrados';
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                            ${message}
                        </td>
                    </tr>
                `;
                return;
            }

            // Sort movements by date (newest first)
            const sortedMovements = [...movementsToShow].reverse();

            sortedMovements.forEach(movement => {
                const typeClass = movement.type === 'entrada' ? 'text-green-600' : 'text-red-600';
                const typeIcon = movement.type === 'entrada' ? 'üì•' : 'üì§';
                
                const row = document.createElement('tr');
                
                // Format date properly handling both ISO and locale formats
                let formattedDate;
                try {
                    const date = new Date(movement.date);
                    if (!isNaN(date.getTime())) {
                        formattedDate = date.toLocaleString('es-ES', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } else {
                        formattedDate = movement.date;
                    }
                } catch (e) {
                    formattedDate = movement.date;
                }
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-900">${formattedDate}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${movement.productName}</td>
                    <td class="px-4 py-3 text-sm ${typeClass} font-medium">${typeIcon} ${movement.type.charAt(0).toUpperCase() + movement.type.slice(1)}</td>
                    <td class="px-4 py-3 text-sm text-gray-900 font-semibold">${movement.quantity}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${movement.description}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Product disable/enable functions
        function showViewProductModal(productId) {
            const product = products.find(p => p.id === productId);
            
            document.getElementById('viewProductName').textContent = product.name;
            document.getElementById('viewProductBrand').textContent = product.brand || '-';
            document.getElementById('viewCurrentStock').textContent = `${product.currentStock} ${product.unit}`;
            document.getElementById('viewUnit').textContent = product.unit;
            document.getElementById('viewMinStock').textContent = product.minStock;
            
            document.getElementById('viewProductModal').classList.remove('hidden');
            document.getElementById('viewProductModal').classList.add('flex');
        }

        function hideViewProductModal() {
            document.getElementById('viewProductModal').classList.add('hidden');
            document.getElementById('viewProductModal').classList.remove('flex');
        }

        function confirmDisableProduct(productId) {
            disableProduct(productId);
        }

        function disableProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                alert('‚ùå Error: Producto no encontrado');
                return;
            }
            
            const displayName = product.brand ? `${product.name} (${product.brand})` : product.name;
            
            try {
                product.disabled = true;
                
                // Add movement record for disabling
                movements.push({
                    id: Date.now(),
                    productId: productId,
                    productName: displayName,
                    type: 'salida',
                    quantity: 0,
                    description: 'Producto deshabilitado - No disponible para movimientos',
                    date: new Date().toISOString()
                });
                
                saveData();
                renderProducts();
                checkLowStock();
                
                alert(`‚úÖ Producto "${displayName}" deshabilitado correctamente. Ahora solo ser√° visible para consulta.`);
                
            } catch (error) {
                console.error('Error deshabilitando producto:', error);
                alert('‚ùå Error al deshabilitar el producto. Por favor, intenta de nuevo.');
            }
        }

        function confirmEnableProduct(productId) {
            enableProduct(productId);
        }

        function enableProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                alert('‚ùå Error: Producto no encontrado');
                return;
            }
            
            const displayName = product.brand ? `${product.name} (${product.brand})` : product.name;
            
            try {
                product.disabled = false;
                
                // Add movement record for enabling
                movements.push({
                    id: Date.now(),
                    productId: productId,
                    productName: displayName,
                    type: 'entrada',
                    quantity: 0,
                    description: 'Producto habilitado - Disponible nuevamente para movimientos',
                    date: new Date().toISOString()
                });
                
                saveData();
                renderProducts();
                checkLowStock();
                
                alert(`‚úÖ Producto "${displayName}" habilitado correctamente. Ya est√° disponible para usar.`);
                
            } catch (error) {
                console.error('Error habilitando producto:', error);
                alert('‚ùå Error al habilitar el producto. Por favor, intenta de nuevo.');
            }
        }


    </script>
</body>
</html>
